CREATE GLOBAL TEMPORARY TABLE TOP_PERFORMER (
  USERID number ,
  CLOSEDCOUNT   number,
  monYear   DATE
)
ON COMMIT PRESERVE ROWS;
create or replace procedure "USER_PERFORMANCE" is begin EXECUTE IMMEDIATE 'TRUNCATE TABLE top_performer'; insert into top_performer select ic.commentedby,count(distinct(closedissues.issueid)),(SELECT to_char(SYSDATE,'dd-Mon-YYYY') FROM DUAL) from issue i,issuecomments ic,MOM_MAINTANANCE mm,(select distinct(i.issueid) as issueid from issue i,issuestatus s where i.issueid=s.issueid and s.status='Closed' and to_char(i.modifiedon,'Mon-YYYY')= to_char(SYSDATE,'Mon-YYYY') minus select distinct issueid from issuecomments where status!='Closed' and (status='Rejected' or status='Duplicate') group by comment_date ,issueid having to_char(Max(comment_date),'DD-Mon-YYYY HH:mm:ss') =to_char(issuecomments.comment_date,'DD-Mon-YYYY HH:mm:ss')) closedissues where closedissues.issueid=i.issueid and i.issueid=ic.issueid and ic.commentedby=ic.COMMENTEDTO and ic.commentedby=mm.USERID group by ic.commentedby order by count(distinct(closedissues.issueid)) desc; insert into top_performer select userid,0,(SELECT to_char(SYSDATE,'dd-Mon-YYYY') FROM DUAL) from( (select mm.USERID from MOM_MAINTANANCE mm,users u where u.USERID=mm.USERID and to_char(u.REGISTEREDON,'YY-MM')<= to_char(SYSDATE,'YY-MM')) minus select userid from TOP_PERFORMER where to_char(monYear,'Mon-YYYY')= to_char(SYSDATE,'Mon-YYYY')); for m in 1..11 loop insert into top_performer select ic.commentedby,count(distinct(closedissues.issueid)),(SELECT to_char(add_months(SYSDATE,-m),'dd-Mon-YYYY') FROM DUAL) from issue i,issuecomments ic,MOM_MAINTANANCE mm,(select distinct(i.issueid) as issueid from issue i,issuestatus s where i.issueid=s.issueid and s.status='Closed' and to_char(i.modifiedon,'Mon-YYYY')= to_char(add_months(SYSDATE,-m),'Mon-YYYY') minus select distinct issueid from issuecomments where status!='Closed' and (status='Rejected' or status='Duplicate') group by comment_date ,issueid having to_char(Max(comment_date),'DD-Mon-YYYY HH:mm:ss') =to_char(issuecomments.comment_date,'DD-Mon-YYYY HH:mm:ss')) closedissues where closedissues.issueid=i.issueid and i.issueid=ic.issueid and ic.commentedby=ic.COMMENTEDTO and ic.commentedby=mm.USERID group by ic.commentedby order by count(distinct(closedissues.issueid)) desc; insert into top_performer select userid,0,(SELECT to_char(add_months(SYSDATE,-m),'dd-Mon-YYYY') FROM DUAL) from((select mm.USERID from MOM_MAINTANANCE mm,users u where u.USERID=mm.USERID and to_char(u.REGISTEREDON,'YY-MM')<= to_char(add_months(SYSDATE,-m),'YY-MM') ) minus select userid from TOP_PERFORMER where to_char(monYear,'Mon-YYYY')= to_char(add_months(SYSDATE,-m),'Mon-YYYY')); END LOOP; end;
